<!doctype html>
<html lang="de" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Campania die Pizza â€“ Start</title>
  <meta name="description" content="Stadtweit beste Pizza. Lieferung oder Abholung â€“ schnell & heiÃŸ.">

  <meta name="theme-color" content="#d64045">
  <link rel="icon" href="assets/favicon.ico">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Campania die Pizza â€“ Braunschweig">
  <meta property="og:description" content="Frische Zutaten, heiÃŸer Ofen, ehrliche Preise. Lieferung & Abholung.">
  <meta property="og:image" content="assets/og/campania-og.png">
  <meta property="og:locale" content="de_DE">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="stylesheet" href="assets/css/style.css">
  <script defer src="assets/js/theme.js"></script>
  <script defer src="assets/js/state.js"></script>
  <script defer src="assets/js/ui.js"></script>
  <script defer src="assets/js/cart.js"></script>
  <script defer src="assets/js/home.js"></script>
  <script defer src="assets/js/auth.js"></script>
</head>
<body>

  <!-- Header -->
  <header class="site-header">
    <a href="index.html" class="logo" aria-label="Campania Startseite">
      <img src="assets/img/logo-light.svg" alt="Campania Logo (hell)" class="logo-img light">
      <img src="assets/img/logo-dark.svg"  alt="Campania Logo (dunkel)" class="logo-img dark">
    </a>
    <nav class="main-nav" aria-label="Hauptnavigation">
      <a href="menue.html">Speisekarte</a>
      <a href="oeffnungszeiten.html">Ã–ffnungszeiten</a>
      <a href="kontakt.html">Kontakt</a>
    </nav>
    <div class="header-actions">
      <button id="themeToggle" class="btn ghost" type="button" aria-label="Theme umschalten">ðŸŒ—</button>
      <a href="konto.html" class="btn link">Konto</a>
      <button id="openCart" class="btn cart" type="button" aria-haspopup="dialog" aria-controls="cartDrawer">
        Warenkorb <span id="cartBadge" class="badge">0</span>
      </button>
    </div>
  </header>

  <!-- Cart Drawer -->
  <div id="cartDrawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="cartTitle" aria-hidden="true">
    <div class="drawer-content">
      <header class="drawer-header">
        <h2 id="cartTitle">Warenkorb</h2>
        <button class="btn icon" id="closeCart" type="button" aria-label="Warenkorb schlieÃŸen">âœ•</button>
      </header>
      <div id="cartItems" class="drawer-body" aria-live="polite"></div>
      <div class="drawer-footer">
        <div id="cartTotals"></div>
        <div class="drawer-actions">
          <a href="kasse.html" id="checkoutBtn" class="btn primary" aria-disabled="true">Zur Kasse</a>
          <button class="btn ghost" id="continueShopping" type="button">Weiter einkaufen</button>
        </div>
        <div id="cartMessages" class="cart-messages" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- Hero (kompakter) -->
  <section class="hero hero--sm surface">
    <div class="hero-inner">
      <h1>Gleich Pizza?</h1>
      <p>Lieferung im Stadtgebiet Braunschweig oder Abholung bei uns vor Ort.</p>
    </div>
  </section>

  <!-- Main -->
  <main id="content" class="container-narrow stack-16">
    <!-- Ã–ffnungsstatus -->
    <section class="card surface shadow-soft pad-16">
      <div id="openStatus">Status wird geladen â€¦</div>
    </section>

    <!-- Bestellstart -->
    <section class="form card surface shadow pad-20" aria-labelledby="bestellstart-heading">
      <h2 id="bestellstart-heading" class="section-title">Bestellstart</h2>
      <p class="field hint">WÃ¤hle zunÃ¤chst den Modus. Bei Lieferung prÃ¼fen wir deine PLZ.</p>

      <form id="modeForm" novalidate>
        <div class="choices" role="group" aria-label="Bestellmodus">
          <button type="button" id="deliveryBtn" class="btn" aria-pressed="false">Lieferung</button>
          <button type="button" id="pickupBtn" class="btn" aria-pressed="false">Abholung</button>
        </div>

        <div id="zipSection" class="field hide">
          <label for="zip">Postleitzahl</label>
          <input id="zip" name="zip" inputmode="numeric" pattern="\d{5}" maxlength="5"
                 autocomplete="postal-code" aria-describedby="zipHint zipError zipInfo"
                 placeholder="z. B. 38100">
          <div id="zipHint" class="hint">Bitte gib deine 5-stellige PLZ ein.</div>
          <div id="zipError" class="error" role="alert" aria-live="assertive"></div>
          <div id="zipInfo" class="notice hide" role="status" aria-live="polite"></div>
        </div>

        <div class="field">
          <button id="continueBtn" class="btn primary" type="submit" aria-disabled="true" disabled>Weiter zur Speisekarte</button>
          <button id="resetBtn" class="btn ghost" type="button">ZurÃ¼cksetzen</button>
        </div>
      </form>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-col">
      <h3>Campania die Pizza</h3>
      <p>HamburgstraÃŸe 260<br>38114 Braunschweig</p>
      <p><a href="tel:+49531234567">+49 531 234567</a></p>
    </div>
    <div class="footer-col">
      <h4>Schnellzugriff</h4>
      <ul>
        <li><a href="menue.html">Speisekarte</a></li>
        <li><a href="oeffnungszeiten.html">Ã–ffnungszeiten</a></li>
        <li><a href="bewertungen.html">Bewertungen</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Rechtliches</h4>
      <ul>
        <li><a href="impressum.html">Impressum</a></li>
        <li><a href="datenschutz.html">Datenschutz</a></li>
      </ul>
    </div>
  </footer>

  <!-- Index-Logik -->
  <script>
  (() => {
    const deliveryBtn = document.getElementById('deliveryBtn');
    const pickupBtn   = document.getElementById('pickupBtn');
    const zipSection  = document.getElementById('zipSection');
    const zipInput    = document.getElementById('zip');
    const zipError    = document.getElementById('zipError');
    const zipInfo     = document.getElementById('zipInfo');
    const form        = document.getElementById('modeForm');
    const contBtn     = document.getElementById('continueBtn');
    const resetBtn    = document.getElementById('resetBtn');

    let rules = []; let ruleMap = null; let mode = null;

    const setPressed = (el, pressed) => el.setAttribute('aria-pressed', String(pressed));
    const showBlock = (el) => { el.style.display = ''; };
    const hideEl    = (el) => { el.style.display = 'none'; };
    const enable    = (btn) => { btn.removeAttribute('disabled'); btn.setAttribute('aria-disabled','false'); };
    const disable   = (btn) => { btn.setAttribute('disabled',''); btn.setAttribute('aria-disabled','true'); };

    function buildRuleMap(){ ruleMap = new Map(rules.map(r => [String(r.zip), r])); }
    function findRule(z){ if(!ruleMap) buildRuleMap(); return ruleMap.get(String(z)); }

    // --- Neu: Regel speichern/clearen + Events fÃ¼r Cart/Kasse
    function saveDeliveryRule(rule, zip) {
      const payload = {
        zip: String(zip),
        mbw: Number(rule.mbw || 0),
        fee: Number(rule.fee || 0),
        free_from: Number(rule.free_from || 0)
      };
      try { localStorage.setItem('campania-delivery-rule', JSON.stringify(payload)); } catch {}
      try { window.dispatchEvent(new CustomEvent('campania:delivery-rule', { detail: payload })); } catch {}
    }
    function clearDeliveryRule() {
      try { localStorage.removeItem('campania-delivery-rule'); } catch {}
      try { window.dispatchEvent(new Event('campania:delivery-rule-cleared')); } catch {}
    }

    function chooseDelivery(){
      mode = 'delivery';
      setPressed(deliveryBtn, true); setPressed(pickupBtn, false);
      zipSection.classList.remove('hide'); // Sichtbarkeit erzwingen
      showBlock(zipSection);
      maybeEnableContinue();
      zipInput?.focus();
    }
    function choosePickup(){
      mode = 'pickup';
      setPressed(deliveryBtn, false); setPressed(pickupBtn, true);
      hideEl(zipSection);
      zipError.textContent = ''; zipInfo.textContent = ''; hideEl(zipInfo);
      clearDeliveryRule(); // Regel entfernen (keine Lieferung)
      enable(contBtn); contBtn.focus();
    }

    function validateZipFormat(v){ return /^\d{5}$/.test(v); }
    function validateZip(){
      zipError.textContent=''; zipInfo.textContent=''; hideEl(zipInfo);
      const val = (zipInput.value||'').trim();
      if(!validateZipFormat(val)){
        clearDeliveryRule();
        disable(contBtn);
        zipError.textContent = val.length ? 'Diese PLZ hat kein gÃ¼ltiges Format (5 Ziffern).' : '';
        return false;
      }
      const rule = findRule(val);
      if(!rule){
        clearDeliveryRule();
        disable(contBtn);
        zipError.textContent='FÃ¼r diese PLZ bieten wir aktuell keine Lieferung an.';
        return false;
      }

      const fee  = Number(rule.fee || 0);
      const free = Number(rule.free_from || 0);
      const mbw  = Number(rule.mbw || 0);

      const feeTxt  = fee > 0 ? `LiefergebÃ¼hr: ${fee.toFixed(2).replace('.', ',')} â‚¬` : 'Lieferung kostenlos';
      const freeTxt = free > 0 ? ` Â· gratis ab ${free.toFixed(2).replace('.', ',')} â‚¬` : '';
      const mbwTxt  = mbw  > 0 ? ` Â· Mindestbestellwert: ${mbw.toFixed(2).replace('.', ',')} â‚¬` : '';

      zipInfo.textContent = `${feeTxt}${freeTxt}${mbwTxt}`;
      showBlock(zipInfo);
      enable(contBtn);

      // Regel fÃ¼r MenÃ¼/Kasse/Warenkorb persistieren
      saveDeliveryRule(rule, val);
      return true;
    }

    let zipTimer; function onZipInput(){ clearTimeout(zipTimer); zipTimer = setTimeout(validateZip, 160); }
    function maybeEnableContinue(){ if(mode==='pickup'){enable(contBtn);return;} if(mode==='delivery'){validateZip();return;} disable(contBtn); }

    async function loadRules(){
      try{
        const res = await fetch('data/plz.json', { cache:'no-store' });
        if(!res.ok) throw new Error();
        rules = await res.json();
        buildRuleMap();
      }catch{
        rules=[]; buildRuleMap();
        if(mode==='delivery'){
          zipError.textContent='LieferprÃ¼fung momentan nicht mÃ¶glich. Bitte versuche spÃ¤ter erneut oder wÃ¤hle Abholung.';
          disable(contBtn);
        }
      }
    }

    function persistMode(){
      try{
        const rule = JSON.parse(localStorage.getItem('campania-delivery-rule') || 'null');
        localStorage.setItem('campania-mode-confirmed',
          JSON.stringify({ mode, zip: zipInput?.value || null, rule })
        );
      }catch{}
    }
    function resetAll(){
      setPressed(deliveryBtn,false); setPressed(pickupBtn,false);
      mode=null; if(zipInput) zipInput.value='';
      hideEl(zipSection); zipError.textContent=''; zipInfo.textContent=''; hideEl(zipInfo);
      clearDeliveryRule();
      disable(contBtn);
      try{ localStorage.removeItem('campania-mode-confirmed'); }catch{}
    }

    deliveryBtn.addEventListener('click', chooseDelivery);
    pickupBtn.addEventListener('click',   choosePickup);
    zipInput.addEventListener('input',    onZipInput);
    resetBtn.addEventListener('click',    resetAll);

    form.addEventListener('submit', (ev) => {
      ev.preventDefault();
      if(mode === 'delivery' && !validateZip()) return;
      persistMode();
      window.location.href = 'menue.html';
    });

    disable(contBtn); hideEl(zipSection); loadRules();
    try{
      const saved = JSON.parse(localStorage.getItem('campania-mode-confirmed')||'null');
      if(saved?.mode === 'pickup'){ choosePickup(); }
      if(saved?.mode === 'delivery'){
        chooseDelivery();
        if(saved.zip){ zipInput.value=saved.zip; validateZip(); }
      }
    }catch{}
  })();
  </script>
</body>
</html>
